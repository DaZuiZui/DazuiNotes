# Java 多线程

## 什么是进程和线程。

我们启动一个mian函数，其实是启动了一个JVM的进程，而main函数所在的线程就是这个进程中的一个，也叫主线程。

进程是一个系统运行程序的基本单位。线程是一个比进程更小的执行单位，一个进程可以产生多个线程，线程会比进程之间进行切换工作小很多，因为线程有共享内存，进程没有他们需要保存和恢复整个进程的状态。（这里的切换是线程的暂停切换到另外一个线程）

## 用户级线程和内核线程

​	用户线程：由用户空间程序管理和调度的线程，运行在用户空间。（专门给应用程序使用），JDK1.2版本之前版本使用。JVM自己模拟了多线程的运行。

​	内核线程:   有操作系统管理和调度的线程，运行在内核空间（只有内核时程序可以访问）jdk版本大于等于 1.2，也就是说JVM直接使用操作系统图原生内核线程来实现的。

Java线程与操作系统的线程关系是一对一也就说，一个Java线程的线程模型是对应一个系统内核线程。

**线程模型主要有三种**

一对多，多对多、一对一

## 从JVM角度说线程 1.8

### 线程共享区域

#### 堆

主要存放我们的对象， 基本所有的创建的对象都会存放到这里，也是我们垃圾回收机主要回收的地方。

#### 元空间（以前的方法区）

元空间主要存储了描述类结构和组成部分的各种信息，这些信息称呼为元信息。比如类的访问修饰符，方法的访问修饰符，方法名字，方法的返回类型， 方法的参数等，使用的是本地内存。

类的加载是懒加载，只有在类的第一次使用的时候才会加载，然后以后再用的时候就去元空间里获取， 比如创建对象。

### 线程私有

####  虚拟机栈

当我们执行一个java方法的时候就会把一个栈帧放到jvm栈中，这个栈帧包含了**局部变量表**(方法参数，局部变量)，**操作数栈**，**方法返回地址**（执行完返回下一条命令的地址），**动态链接**（方法的引用）

####  本地方法栈

​		本地方法栈和jvm栈是一样的，唯一区别的就是本地方法栈是为用来操作系统的方法的。

####  程序计数器

​		字节码解析器通过改变程序计数器依次来读取指令，实现代码的流程龙之如顺序执行、选择、循环、异常处理。

​		在多线程记录当前线程执行的位置，在线程切换知道该线程上次运行到哪里了。

### 本地内存

#### 元空间

​	上面有介绍

###  直接内存

​	直接内存是使用NIO包中的ByteBuffer类来操作的一种内存，他不受java堆的管理，也不受jvm gc管理，直接内存的分配和释放由操作系统实现。

​	它与Java堆外的物理内存直接映射，可以不受jvm 堆大小的限制。

​	直接内存可以通过0拷贝的技术提高I\O的操作性能，因为它的数据可以在Java堆和本地内存之间的传输。

​	在内存释放方面是比较延迟的，当我们执行claer方法只是清除了ByteBuffer的状态，并没有释放真正的内存要等操作系统来释放。

NIO的优化就是比传统IO少了一步操作，就是少了把堆外内存拷贝到堆内内存。

#### NIO

##### 写

​	使用ByteBuffer进行数据的读写，将数据写到直接缓冲区，这个直接缓冲区（Direct ByteBuffer）对应着堆外内存。（第一次拷贝，从用户空间到内核空间）

​	写时调用force()方法刷新到文件系统的穿冲区，然后等操作系统刷新到硬盘（这是第二次拷贝）

##### 读

​	硬盘读取数据到文件系统的缓冲区，然后通过通道传输到内核空间，最终拷贝到用户空间的缓冲区。