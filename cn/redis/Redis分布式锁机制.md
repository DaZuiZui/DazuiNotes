# Redis分布式锁机制

## 获取锁

首先采用set方法获取锁

~~~java
SET lock_key unique_value NX PX 30000
~~~

lock: 是锁的名字 标识锁的

uniqu_value： 唯一值，通常是一个UUDI，确保不会被其他客户端释放。

NX： 只在键不存在的时候才会

PX：锁的过期时间，单位是毫秒 这里是30秒

## 释放锁

首先检查unique_value是否匹配，匹配了才能释放。

## 锁续命（可选）

~~~java
PEXPIRE lock_key 30000
~~~

对锁续命多久

## 主从节点分布式锁情况

在主从复制的情况当我们的主节点有了锁他会同步给其他的节点。但是某种特殊情况可能会存在从节点稍有延迟生效。

### 为什么把锁同步给其他节点

因为当主节点发生故障的时候会同步给其他节点，这么做的原因主要有

#### 主节点死亡了

当主节点死亡了这个时候，从节点就会变成为主节点，这个时候主节点设置的锁就会继续生效。

但是依然有问题，如果这个从节点没有获取到锁，那么就会出现问题，可以使用Redlock进行处理。

#### 读取负载分担

尽管读节点不进行read操作，但是他可以处理大部分读操作，包括读取锁。

### 解决方案Redlock

redlock的工作原理就是，所有节点进行投票如果大家同意获取锁，那么就上锁。

## Redisson

他其实就一个开门口机制，首先对一个锁进行上锁，如果n秒内没完成操作就对这个锁进行续命，当然也可以设置最大使用锁的时间，如果这些时间没有完成那么就进行一个回滚。