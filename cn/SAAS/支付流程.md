# Ebanx支付流程

## 信用卡 银行卡Direct API

### 1.用户点击订阅

在ebanx_subscription 创建一条数据，状态pending （还没支付成功）

在那时没有card_token 只记录userid和productId，和周期信息

### 2.展示Drop-in（Ebanx）

 用户填写信用卡信息，Ebanx返回一个临时token

ebanx_paymant 建立一条 state=pending，token = 临时token

这个payment关联刚才的subsription。

### 3.用token调用Exban Direct API扣款

发起一次支付请求。

​	ebanx_payment 更新state=success 填写ebanx_payment_id（Ebanx 返回的唯一凭证）

​	ebanx_subscription 更新 state=active。card_token（保存Ebanx返回的长期token，用于下次扣款）

​		lastest_payment_id = 当前的payment_id

​		current_period_start = 周期开始时间 , current_period_end  = 周期结束时间



### 下一周期触发

使用exbanx_subscription.card_token 发起付款

ebanx_payment -> 创建一条 state = pending

ebanx_subscription  -> 更新lastest_payment_id 和新周期的	current_period_start = 周期开始时间 , current_period_end  = 周期结束时间



## Pix自动扣款

### 1.用户点击订阅

我们系统请求Ebanx创建**合同签约**，返回一个二维码

​	数据库ebanx_subscription -> 创建一条记录，state=pending 等待用户扫码

​    ebanx_payment -> 新建一条，state=pending，存pix_qr_code

### 2.用户扫码签约合同

用户同意授权，Ebanx回调签约成功

ebanx_subscription 更新

state=active

pix_enrollment_id 为签约id

current_period_start = new Data()  开始的, current_period_end  = new Data()  结束的



ebanx_payment

state= success

Ebanx_payment_id 首付款id

### 3.周期性扣费

Ebanx在到期前2~10天发起

操作：操作Ebanx自动发起扣款，并回调支付结果

ebanx_payment 在回调的时候插入一个新的支付记录 state=pending

扣款成功 更新为state =success

ebanx_subscription 更新latest_payment_id 为这个的id。	current_period_start = 周期开始时间 , current_period_end  = 周期结束时间



用户取消订阅  请求Ebanx取消签约

 ebanx_)subscription 更新 state=canceled。cabceled_At 时间