# 高并发资源扣减

在一些并发的场景，可以读到相同的资源库存，如果没有做有效的兵法控制，可能导致库存被超扣。

## 其实最重要的就是乐观锁实现防止多扣或者少扣

1.就是在资源表里增加一个version字段

2.请求读取当前资源库存和版本号

~~~sql
SELECT stock, version FROM resource WHERE id = ?;
~~~

3.尝试更新

~~~sql
UPDATE resource
SET stock = stock - 1, version = version + 1
WHERE id = ? AND version = ? AND stock >= 1;
~~~



因为我们这个业务，这个用户资源写不是这么多所有可以这么写