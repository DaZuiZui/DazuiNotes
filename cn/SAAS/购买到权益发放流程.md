# 购买到权益发放流程

## 1.分布式锁

首先分布式锁，同一个用户30秒之可以一个创建订阅的流程



## 2. 商品优惠校验

这一步就是校验在售的商品和可用卷，还有优惠卷，如果失败了立即返回



## 3. 支付的方式绑定

从前段传过来的setupIntentId去除paymentMethodId，绑定到StripeCustomer的默认支付方式。



## 4. 创建Stripe订阅

通过stripe subscription API创建订阅，设置行为，优惠卷，默认支付方式，元数据等， 

- DEFAULT_INCOMPLETE 模式：需要后续确认支付（latest_invoice.payment_intent）

- metadata 记录 userId、appId、订单信息、productId、环境等，后续 Webhook 依赖这些信息来定位业务对象

## 5. 订单落库与状态

这个时候会把订单和明细和绑定的subscriptionId和payment_intent。然后标记为待支付的状态

## 6.stripe收到钱了 开始发送权益

当stripe收到钱了， 向webhook发起回调，然后在根据不同的状态转发到对应的处理器（比如 创建，升级降级，周期变更）

然后开始真正的发送权益了。 流程就是清理旧资源 → 插入/更新新资源 → 记录积分来源 → 写 userPackage。

Webhook 内使用“唯一任务”去重，避免重复发放
