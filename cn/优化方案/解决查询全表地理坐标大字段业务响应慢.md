# 解决查询全表地理坐标大字段业务响应慢 业务

## 问题背景

​	当查询一个存放地理位置表的时候,该地理坐标表存放地址列的type为longtext，并且每个字段内的数据都是大字段，该表共1万4000+数据量，总表大小为50MB左右，现在有一个需求，需要把该表所有数据进行读取出来返回给前端。但这个业务接口处理完需要40秒左右，甚至50秒。

## 解决方案

## 初步尝试优化：采用多线程分页查询 

​	该方案速度有所提升，但是效果不是很明显，依然需要30秒左右，这显然是不能满足业务需求的。

## 第2次优化:更改数据类型Geometry

​	将数据类型更改为Geometry，然后将1万4000条地理数据导入表中后，这时候整张表大小只有16kb，但是问题所在，但是Mybatis是无法直接获取这个类型的数据，那么问题来了我们该如何获取这个Geometry字段。

## 第3次优化:尝试数据库使用ST_AsText进行处理

当数据使用ST_AsText进行把Geometry作为字符串返回了时候，这时候问题又回来了，作为字符串，数据库业务传输的数据大小太大了，依然回到了30秒左右。

### 为什么都是字符串反而ST_AsText更快了。

​	因为数据库有对Geometry进行优化，Geometry采用了更加紧凑和容易优化的存储结构，Mysql也有对Geometry也有一些专门的优化策略，而直接字符串存储的坐标的表反而享受不到这个优化策略。

## 第4次优化:采用使用字节流接受

​	在我们后端采用了字节流进行接受，然后在java后端通过将字节流转换为16进制，然后在通过Geo组件转换为Geometry对象，经过这个方法速度得到了很大的提升，可以做到19秒左右处理好业务。但是19秒过于漫长

## 第5次优化:采用多线程获取数据（以字节流方式接受）

​	经过多线程方式进行查询处理接口处理业务的速度变成了15秒左右，但是还是有优化空间。

## 第6次优化：寻找内存连续的地方耗费的时间。

​	ArrayList的内存是连续的，在找这片内存的连续空间是有些费事，我们返回的数据类型是List<List<List<Double>>>,如果寻找这一片连续的空间是非常耗时的，所以我将最外部的List更为LinkedList，这样为最外部的list省去了寻找特别大的连续空间所耗的时间。内部的使用Arraylist，因为在转json的过程中，我外部的LinkedList只会引入4或者5个内部的ArrayList，在转json压力会小一点，而内部的ArrayList有大量的数据，他们内存是连续的在转json的时候会快很多。

## 第7次优化:ArrayList扩容导致的性能下降

​	在业务代码发现，ArrayList在不断扩容，在ArrayList扩容是非常耗费性能，也浪费时间，但是我们的业务可以告诉我们ArrayList需要多大的空间，所以使用ArrayList.ensureCapacity()提前确定好大小，减少扩容次数从而提高性能，此时时间优化到**13.74.**