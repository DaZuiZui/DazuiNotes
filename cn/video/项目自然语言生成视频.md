# 项目自然语言生成视频

## 1. 业务流程

### 1. 初步校验

首先进入这个业务会先对前端的参数进行校验，然后还有对用户的权益进行校验，然后开启一个核心异步逻辑（选择模版并且开始渲染），然后生成一个ReqID立刻返回给前端，方便前端进行查询任务状态。

### 2.核心异步逻辑（选择模版开始渲染）

这一步先会把所有的入参持久化保存起来，然后异步执行通过工作流Agent（LLM）分析素材、获取能用的所有模版（包含这个模版配套的信息，如音频），然后根据选择一个合适的模版和一个合适的配套信息（如音频 贴纸 是否图片动态化）。如果出错了就会抓捕异常发送到飞书和邮件警报。

当获取到了合适的模版，就会配置好一些这个模版的信息，进入下一步渲染模式

### 3.渲染

这个时候就是为这个主要会经历 分析素材-音乐打点-自定义脚本分段并生成口播-大纲生成 - 生成结构脚本-生成口播文案-生成口播-口播和视频时长匹配（因为根据文本生成出来的口播可能不符合我们的预期需要重新计算下他和我们视频匹配的位置）-画中画--音效-贴纸-对口型。

### 4. 扣费

如果成功成功则进行权益扣减。

## 2. 扩展问题

### 1.为什么这个接口要异步执行

因为避免http长链接堵塞， 模版选择和 LLM分析和渲染都是异步操作的， 然后前端根据reqID进行轮询。

### 2. 如何保证一个请求产生多个字任务可以被关联和追踪

因为一个reqID下生成的任务都有有一个id与ReqID进行绑定

### 3. LLM输出格式不稳定如何处理

每次LLM输出的内容我们都会进行一次解析，如果格式错误或者缺失某个字段都会抛异常然后保存关键信息发送到飞书通知上。

### 4. 如何做配额计费保护

其实他的自然语言生成视频单个视频就是50积分，这个很好做直接算就行，

### 5. 如果失败了积分怎么回滚

他的任务会在我们数据库有个状态的，如果已经扣积分了我们就会根据状态进行回补。