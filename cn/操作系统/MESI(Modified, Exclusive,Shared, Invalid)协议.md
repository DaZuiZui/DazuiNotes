# MESI(Modified, Exclusive,Shared, Invalid)协议

## 四种状态

## Modified

缓存行的数据已被修改，与主内存中的数据不一致，并且将缓存行是独占的（其他缓存不包含此数据）。当此数据写到主内存的时候，状态就会变成共享独占的。

## Exclusive

缓存行的数据与主内存中的数据一致，且该数据仅存在于当前缓存中。没有其他缓存拥有此数据的时候，可以直接修改数据，不需要通知其他缓存

## Shared

缓存行的数据与主内存中的数据一致，且数据可能存在多个缓存中。此状态下，数据可以被读取，但不能直接修改，修改前需要通知其他缓存并将状态变为Modified

## Invalid

缓存行的数据无效，表示当前缓存中的该数据无效，需要从主存或其他重新加载数据。

## MESI协议的过程

### 读操作

如果缓存行状态是Invalid，会发生缓存未命中，处理器需要从主存或其他缓存中获取数据，加载到缓存中，并将状态设置为Shared（如果其他缓存中有该数据），或 Exclusive（如果其他缓存中没有该数据）。

### 写操作

如果缓存行的状态是Invalid或者Shared的时候就会发生缓存未命中，处理器需要发出总线请求，将其他缓存中的钙数据设置为Invalid，并将状态设置为Modified。然后进行写操作。

###  缓存行失效（Invalidata）

当一个处理器修改数据的时候，MESI协议要求其他处理器的缓存中相应的缓存行状态未Invalid，这通常通过广播Inalidate消息实现。当其他缓存接受到该消息的时，如果他们缓存中没有此数据行，状态将设置为Invalid

### 数据回写

当一个缓存行的状态从Modified变成Invalid或者从Modified变成Shared或者Exclusive的时候，修改的数据需写回主内存，已确保主内存数据的一致性。



## 工作流程

假如两个处理器P1和P2，他们共享一个缓存行X

P1读X：如果X不在P1缓存中（X的状态为Invalid），P1会从主内存读取X，将X的状态设置为Exclusivbe。

P2读X：如果X此时在P1的缓存中且状态为Exclusive，P2读取的时候会将X的状态变成Shared（在P1和P2中都为Shared）

P1写入X： 如果P1想要修改X，他会发出Invalidate信号，通知P2将X的状态变为Invalid，然后P1将X的状态设置为Modified并进行修改。

通过上面的操作MESI协议确保在多处理器系统中，所有处理器对同一数据的访问是同步且一致的。有效避免了缓存一致性的问题。