# 消息队列堆积过大

其实对于消息堆积我们主要通过2个界面进行监控，一个是消息队列对应的管理面板，还有一个是我们系统自研的监控面板出现问题了（如消息出现延迟）会自动在飞书进行警报。

一般来说我们会看Consumergroup的一个消息延迟时间还有一个堆积数量这2个关键的数据，如果发现问题了， 我会第一时间看是消费者死亡了， 还是消费者消费的速度跟不上生产的速度，或者消费者逻辑出现堵塞。

## 经历过的消息堆压

我经历过最严重的一次消息堆压就是接手一个实习生的bug，因为我们对接第三方api，但是那个API是同时只能处理n个请求，太多了就会被拒绝，然后这个实习生写了一个如果失败了就重新塞进去队列里。导致消费的速度没有生产的快。最终更改了逻辑，和第三方也沟通了

## 如何预防消息队列堆积

一定要有一个完善的监控预警的系统，不仅要看堆积数量还要有监控消费TPS(每秒成功消费数量)，消费延迟时间等指数，并设置了多级告警阈值

消息延迟时间

~~~java
10:00:00  消息生产（produce）
10:00:01  消息进入队列
10:00:08  消费者真正开始处理

~~~

