# 乐观锁实现防止多卖错卖

可以用乐观所也可以用悲观锁，市场主要常见的2种方案。

悲观锁比较适合读少写多，乐观所适合读多写少，所以乐观所更合适。

乐观锁主要通过版本号的方式来实现，每次更新数据的时候都会检测版本号是否一样。如果不一样就是有问题。

乐观锁的优点就是减少了锁的竞争，提高了系统的吞吐量，但是缺点就是在高并发写冲突比较多的时候可能会导致大量重试，一直自旋影响性能。

之前我们卖过指定数量的特价订阅套餐的时候就是用的乐观锁，在库存表里增加一个版本号，每次扣减的时候都会查看这个版本号去更新，但是并发特别高的时候就会很多请求因为版本号重试导致失败，然后我来优化了一下，吧失败的请求放在一个队列里面，这样异步重试就可以缓解一部分压力了。

另外我们还结合了， redis来减少数据库的操作，比如先在redis进行预减，然后在统一更新到数据库里面，这样可能减少乐观锁竞争的压力。

乐观锁不适合写多的情况，如果写多的场景适合悲观锁。

一般来说悲观锁都是搭配事务一起来用的为了防止出现不一致性。
